# Архитектура проекта Lab Async Go

## Общая архитектура

\`\`\`
┌─────────────────────────────────────────────────────────┐
│                  ГЛАВНАЯ ПРОГРАММА                      │
│                  (cmd/main.go)                          │
└─────────┬───────────────────────────────────────────────┘
          │
          │ Использует
          │
    ┌─────┴─────────────────────────────────────────┐
    │                                               │
    ▼                                               ▼
┌────────────┐                             ┌──────────────┐
│  Пакет     │                             │  Пакет       │
│  async/    │                             │  server/     │
└────────────┘                             └──────────────┘
    │                                               │
    │ Содержит 15 компонентов:                    │ Содержит:
    │ - 6 горутин компонентов                     │ - HTTP Server
    │ - 9 каналов компонентов                     │ - Middleware
    │ - 3 Worker Pool типа                        │ - Обработчики
    │                                               │
    ▼                                               ▼
┌──────────┬──────────┬───────┬─────────┐  ┌──────────┐
│ Counter  │ Map      │ Filter│ Reduce  │  │ Routes   │
│ Producer │ Consumer │Pipeline Merge   │  │ Handlers │
│ FanOut   │ FanIn    │ Rate  │ Bounded │  │ Middleware
│ Worker*  │ RateLimit│Queue  │Semaphore  │
└────────────────────────────────────────┘  └──────────┘
\`\`\`

## Жизненный цикл горутины

\`\`\`
             ┌──────────────┐
             │   Created    │
             │  (go func()) │
             └──────┬───────┘
                    │
                    ▼
        ┌─────────────────────┐
        │    Running          │
        │ (выполняется код)   │
        │                     │
        │  ┌─────────────┐    │
        │  │  Blocked    │    │
        │  │ (ждет сигнал)    │
        │  └────────┬────┘    │
        │           │         │
        │           ▼         │
        │      Ready          │
        └──────┬──────────────┘
               │
               ▼
        ┌─────────────────┐
        │   Terminated    │
        │  (завершена)    │
        └─────────────────┘
\`\`\`

## Модель памяти Go

```
           ┌─────────────────────────────┐
           │    Shared Memory Model      │
           └─────────────────────────────┘
                  │         │
        ┌─────────┘         └─────────┐
        │                             │
        ▼                             ▼
    ┌────────┐                   ┌──────────┐
    │ Mutex  │                   │ Channels │
    │ (LOCK) │                   │ (QUEUE)  │
    └────────┘                   └──────────┘
    
    Правило: Не делитесь памятью
    через коммуникацию, вместо этого
    делитесь коммуникацией для
    синхронизации памяти.
```

## Модель Worker Pool

```
┌────────────────────────────────────────────┐
│         WORKER POOL (N = 3)                │
├────────────────────────────────────────────┤
│                                            │
│  Task Queue                                │
│  ┌──────┬──────┬──────┬──────┬──────┐    │
│  │Task1 │Task2 │Task3 │Task4 │Task5 │    │
│  └──────┴──────┴──────┴──────┴──────┘    │
│           ▲
│           │ Submit
│           │
│  ┌─────────────────────────────────┐    │
│  │   Worker 1   Worker 2  Worker 3 │    │
│  │                                 │    │
│  │  [TASK1]     [TASK2]   [TASK3]  │    │
│  │   ▼▼▼▼▼       ▼▼▼▼▼     ▼▼▼▼▼   │    │
│  │  Process    Process    Process  │    │
│  │   ▲▲▲▲▲       ▲▲▲▲▲     ▲▲▲▲▲   │    │
│  └─────────────────────────────────┘    │
│           │
│           ▼
│     Results Queue
│
└────────────────────────────────────────────┘
```

## Pipeline обработки

```
Input Stream
    │
    ▼
┌─────────┐
│ Stage 1 │  (Transformation 1)
│ (x * 2) │
└────┬────┘
     │
     ▼
┌─────────┐
│ Stage 2 │  (Transformation 2)
│ (x + 10)│
└────┬────┘
     │
     ▼
┌─────────┐
│ Stage 3 │  (Transformation 3)
│ (x / 2) │
└────┬────┘
     │
     ▼
Output Stream
```

## Синхронизация в Go

```
┌──────────────────────────────────────────────┐
│    Механизмы синхронизации в Go             │
├──────────────────────────────────────────────┤
│                                              │
│  1. Каналы (Channels)                        │
│     ├─ Буферизованные                        │
│     └─ Небуферизованные                      │
│                                              │
│  2. Мьютексы (Mutex)                         │
│     ├─ sync.Mutex                            │
│     └─ sync.RWMutex                          │
│                                              │
│  3. WaitGroup                                │
│     ├─ Add()                                 │
│     ├─ Done()                                │
│     └─ Wait()                                │
│                                              │
│  4. Atomic операции                          │
│     ├─ AddInt64()                            │
│     └─ LoadInt64()                           │
│                                              │
│  5. Context                                  │
│     ├─ WithCancel()                          │
│     ├─ WithTimeout()                         │
│     └─ WithDeadline()                        │
│                                              │
└──────────────────────────────────────────────┘
```

## HTTP Server архитектура

```
┌─────────────────────────────────────────┐
│        HTTP Request                     │
└────────────┬────────────────────────────┘
             │
             ▼
    ┌─────────────────┐
    │ Logging Middleware
    │ (логирует запрос)
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │ Recovery Middleware
    │ (обрабатывает паники)
    └────────┬────────┘
             │
             ▼
    ┌─────────────────────────────────┐
    │      Router / Handler            │
    │  ├─ GET /health                  │
    │  ├─ GET /stats                   │
    │  ├─ GET /echo                    │
    │  ├─ GET /delay                   │
    │  └─ GET /heavy                   │
    └────────┬────────────────────────┘
             │
             ▼
    ┌─────────────────┐
    │ Response Writer │
    │ (отправляет)    │
    └────────┬────────┘
             │
             ▼
┌─────────────────────────────────────────┐
│      HTTP Response                      │
└─────────────────────────────────────────┘
```

## Race Condition пример

```
WITHOUT Mutex:
┌──────────┐      ┌──────────┐
│ Goroutine│      │ Goroutine│
│    1     │      │    2     │
└────┬─────┘      └────┬─────┘
     │ Read(counter)   │
     │ 0               │
     │                 │ Read(counter)
     │                 │ 0
     │ Write(1)        │
     │                 │ Write(1)
     │                 │ 
     ▼                 ▼
   Result: counter = 1 (ОШИБКА! Должно быть 2)

WITH Mutex:
┌──────────┐      ┌──────────┐
│ Goroutine│      │ Goroutine│
│    1     │      │    2     │
└────┬─────┘      └────┬─────┘
     │ Lock()          │
     │ Read(0)         │
     │ Write(1)        │ Wait...
     │ Unlock()        │
     │                 │ Lock()
     │                 │ Read(1)
     │                 │ Write(2)
     │                 │ Unlock()
     ▼                 ▼
   Result: counter = 2 (ПРАВИЛЬНО!)
```

## Масштабируемость компонентов

```
Throughput (задач/сек)
│
│         Worker Pool
│             ▲
│            /│\
│           / │ \
│          /  │  \
│         /   │   \
│        /    │    \
│       /     │     \___________
│      /      │                
│     /  Pipeline              
│    /        │\               
│   /         │ \____          
│  /  FanOut  │      \__       
│ /           │          \___  
└─────────────┴──────────────────► Количество рабочих
  1          5          10         20
```

## Закон Амдала - Теоретическое ускорение

```
Speedup (ускорение)
│
│
10│                               
9 │
8 │        P = 0.9 (90% параллелизм)
7 │      /
6 │     /
5 │    /
4 │   /___P = 0.5 (50% параллелизм)
3 │  /    \___
2 │ /         \___
1 │/_______________\___► N (количество процессоров)
  └─────────────────────
    1  4  8  16  32
```

## Покрытие кода тестами

```
┌─────────────────────────────────────┐
│     Test Coverage Analysis          │
├─────────────────────────────────────┤
│ goroutines.go     ████████░░  85%   │
│ channels.go       ████████░░  82%   │
│ worker_pool.go    ████████░░  80%   │
│ http.go           ███████░░░  78%   │
│                                     │
│ TOTAL             ████████░░  82%   │
│ TARGET            ████████░░  80%   │
│                                     │
└─────────────────────────────────────┘
```