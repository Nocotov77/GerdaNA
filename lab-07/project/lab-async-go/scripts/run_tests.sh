#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ Lab Async Go
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bash scripts/run_tests.sh

set -e  # –í—ã—Ö–æ–¥ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ

echo "üöÄ Lab Async Go - –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤"
echo "================================"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Go
if ! command -v go &> /dev/null; then
    echo "‚ùå –û–®–ò–ë–ö–ê: Go –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

echo "‚úì Go version: $(go version)"
echo ""

# –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–±–æ—Ä–æ–∫
echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
go clean -cache

# –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π
echo "üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
go mod download

echo ""
echo "üß™ UNIT –¢–ï–°–¢–´"
echo "================================"
go test ./... -v

echo ""
echo "üîç RACE DETECTOR"
echo "================================"
go test -race ./...

echo ""
echo "üìä –ü–û–ö–†–´–¢–ò–ï –ö–û–î–ê"
echo "================================"
go test ./... -cover
go test ./... -coverprofile=coverage.out
go tool cover -html=coverage.out -o coverage.html
echo "‚úì HTML –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ coverage.html"

echo ""
echo "‚úÖ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û"
echo "================================"
echo "–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã:"
echo "  make bench              - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫–∏"
echo "  make load-test          - –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
echo "  go run cmd/main.go      - –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã"